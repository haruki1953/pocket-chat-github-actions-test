name: Release

on:
  release:
    types: [published]   # 当发布 Release 时触发
  workflow_dispatch:     # 也允许手动触发

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  id-token: write        # 用于 OIDC 身份令牌，生成签名证明
  contents: write        # 需要写权限才能上传 Release 资产，同时包含读权限
  attestations: write    # 写入 attestation 记录
  packages: write        # 如果工件要发布到 GitHub Packages，需要写权限

jobs:
  # 构建前端、打包项目并上传至Release
  build-vue3-and-project-package-and-upload-release-zips:
    runs-on: ubuntu-latest

    steps:
      # 从当前 GitHub tag 名中提取版本号，并写入环境变量 VERSION
      # ${GITHUB_REF_NAME#v} 表示去掉 tag 前缀 "v"，例如 "v0.0.3" 会变成 "0.0.3"
      # >> $GITHUB_ENV 会把 VERSION 变量持久化到 GitHub Actions 环境中，
      # 后续步骤可以通过 ${{ env.VERSION }} 使用该版本号
      - name: Extract version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      # 拉取仓库代码
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      # 安装指定版本的 pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@eae0cfeb286e66ffb5155f1a79b90583a127a68b
        with:
          version: 10.8.1

      # 为 project-tools-node 子项目设置 Node.js 环境，并启用 pnpm 缓存
      # 使用 cache-dependency-path 指定该子项目的 lockfile，确保依赖缓存命中准确
      - name: Setup Node.js (project-tools-node)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: project-tools-node/pnpm-lock.yaml

      # 为 vue3 前端子项目设置 Node.js 环境，并启用 pnpm 缓存
      # 同样指定 vue3 的 lockfile，避免不同子项目的依赖缓存互相干扰
      - name: Setup Node.js (vue3)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: vue3/pnpm-lock.yaml

      # 安装前端依赖
      - name: Install vue3 dependencies
        run: |
          cd ${{ github.workspace }}/vue3
          pnpm install --frozen-lockfile

      # 构建前端项目，生成 vue3/dist/
      - name: Build frontend
        run: |
          cd ${{ github.workspace }}/vue3
          pnpm build

      # 安装工具脚本依赖
      - name: Install project-tools-node dependencies
        run: |
          cd ${{ github.workspace }}/project-tools-node
          pnpm install --frozen-lockfile

      # 执行下载脚本，获取 PocketBase 各平台二进制文件
      - name: Download PocketBase release files
        run: |
          cd ${{ github.workspace }}/project-tools-node
          node project-pocketbase-download.js

      # 执行打包脚本，传入版本号（去掉 v 前缀）
      # 将输出到 out/${{ env.VERSION }}/dist 和 out/${{ env.VERSION }}/release
      - name: Package project
        run: |
          cd ${{ github.workspace }}/project-tools-node
          node project-package.js ${{ env.VERSION }}

      # 上传 dist/ 目录作为 CI 工件，方便调试或后续 job 使用
      - name: Upload dist artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: out-dist
          path: ${{ github.workspace }}/out/${{ env.VERSION }}/dist/

      # 将 release/*.zip 上传到 GitHub Release 页面
      # overwrite: true 表示覆盖已有同名文件
      # file_glob: true 表示允许 Action 展开通配符，把匹配到的多个文件都上传到 Release。
      - name: Upload release zips
        uses: svenstaro/upload-release-action@6b7fa9f267e90b50a19fef07b3596790bb941741
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ github.workspace }}/out/${{ env.VERSION }}/release/*.zip
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true

      # 生成构建证明 (artifact-attestations)，绑定到 Release 资产
      # 用户下载时可验证 zip 文件确实由 GitHub Actions 构建
      - name: Generate build provenance
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be
        with:
          subject-path: ${{ github.workspace }}/out/${{ env.VERSION }}/release/*.zip
