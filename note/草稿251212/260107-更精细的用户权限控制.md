先修一下图片集合中字段的顺序
```
哦，好像不行，改字段顺序不会添加新的pb_migrations
算了等v1正式版时破坏性更新时合并pb_migrations时再调整吧
```

用户头像大小限制放宽一些吧，1M

## 更精细的用户权限控制

users集合 字段
```
canSendMessage
控制该用户是否能发送消息 select "YES" | "NO" | ""
""空字符串即为默认，此时由config集合配置值控制

canUploadImage
控制该用户是否能上传图片 select "YES" | "NO" | ""
""空字符串即为默认，此时由config集合配置值控制

isBanned
控制是否封禁该用户 boolean
false为默认值，为true时即表示此用户已被封禁
```

config集合 配置值
```
config集合 是固定的除自动配置的字段外只有两个字段，key字段string 和 value字段json

user-register-oauth2-only
是否只允许oauth2注册，为布尔值
配置为true即用户不能使用账号密码注册或登录，只能使用oauth2
（建议在将此值配置为true前，确保配置了oauth2。
如果想只允许账号密码注册登录则不设置user集合配置中的oauth2即可）

user-can-send-message-default
当用户集合字段canSendMessage未显式配置时，是否默认允许发送消息，为布尔值

user-can-upload-image-default
当用户集合字段canUploadImage未显式配置时，是否默认允许上传图片，为布尔值

admin-contact-info
管理员联系方式，主要用于用户权限不足时，提示给用户的联系方式
```

修改实现规划
```
先前后端修改 config 相关（前端校验，后端初始化）
修改集合
users 增加字段，并修改api规则
messages 修改api规则
images 修改api规则
```

## 前端体现
```
登录页，只允许oauth2注册时，不显示注册栏
聊天页，输入栏（底栏），显示无发送消息权限
图片选择页，上传框，显示无上传图片权限
isBanned 时，在 app.vue 中直接v-if显示空页面
```

## 集合api规则

### users集合 api规则
```
(
  创建时需为 oauth2 ，或 user-register-oauth2-only 为 false
  且 @request.auth.id == ""
)
创建时禁止设置 canSendMessage canUploadImage isBanned
更新时禁止设置 canSendMessage canUploadImage isBanned
```
注意处理isBanned

#### users集合 查看规则
```c
// 访问主体的前置条件 ，根据配置值判断未登录用户是否可以查看
(
  // 用户已登录，可以查看
  @request.auth.id != '' ||
  // 根据config，判断是否允许未登录用户查看
  (
    @collection.config:allowAnonymousView.key ?= 'allow-anonymous-view' &&
    @collection.config:allowAnonymousView.value ?= true
  )
) &&
// 访问主体的权限条件，只有isBanned为false的用户才能访问，或当前为访问自己的
(
  // 用户未登录时可通过，因为匿名访问已在前置条件控制
  @request.auth.id = '' ||
  // 用户已登录，检查其isBanned
  (
    // 不为 isBanned 才能通过
    (
      @collection.users:isBannedCheck.id ?= @request.auth.id &&
      @collection.users:isBannedCheck.isBanned ?= false
    ) ||
    // isBanned 时，只查自己的用户数据，可以通过
    id = @request.auth.id
  )
)
```

#### users集合 创建规则
```c
// 根据config，允许注册时 才通过（且进行下一条件判断）
(
  @collection.config:allowRegister.key ?= 'allow-users-to-register' &&
  @collection.config:allowRegister.value ?= true
) &&
// 配置中并非只允许oauth2注册时 或 oauth2注册时 才通过（且进行下一条件判断）
(
  // config配置中，非 只允许oauth2注册 通过
  (
    @collection.config:oauthOnly.key ?= 'user-register-oauth2-only' &&
    @collection.config:oauthOnly.value ?= false
  ) || 
  // 这里即只允许oauth2注册
  (
    // 上下文为oauth2 且 当前未登录时 通过
    // 当前未登录这个判断主要用于防止已登录的用户再次注册
    @request.context = 'oauth2' &&
    @request.auth.id = ''
  )
) &&
// 资源本身的可访问性条件
(
  // 这些值不能由用户控制，不能设置
  @request.body.canSendMessage:isset = false &&
  @request.body.canUploadImage:isset = false &&
  @request.body.isBanned:isset = false
)
```

#### users集合 更新规则
```c
// 访问主体的前置条件 ，需登录
@request.auth.id != '' &&
// 访问主体的权限条件，isBanned为false的用户才能访问
(
  @collection.users:isBannedCheck.id ?= @request.auth.id &&
  @collection.users:isBannedCheck.isBanned ?= false
) &&
// 资源本身的可访问性条件
(
  // 只能修改用户自己的
  id = @request.auth.id
  // 这些值不能由用户控制，不能设置
  @request.body.canSendMessage:isset = false &&
  @request.body.canUploadImage:isset = false &&
  @request.body.isBanned:isset = false
)
```

### message集合 api规则
创建规则、修改规则
```
(
  用户的canSendMessage为 YES
) ||
(
  用户的canSendMessage为"" &&
  user-default-can-send-message为true
)
```
注意处理isBanned

#### message集合 查看规则
```c
// 访问主体的前置条件 ，根据配置值判断未登录用户是否可以查看
(
  // 用户已登录，可以查看消息
  @request.auth.id != '' ||
  // 根据config，判断是否允许未登录用户查看消息
  (
    @collection.config:allowAnonymousView.key ?= 'allow-anonymous-view' &&
    @collection.config:allowAnonymousView.value ?= true
  )
) &&
// 访问主体的权限条件，只有isBanned为false的用户才能访问
(
  // 用户未登录时可通过，因为匿名访问已在前置条件控制
  @request.auth.id = '' ||
  // 用户已登录，检查其isBanned 为 false 才能通过
  (
    @collection.users:isBannedCheck.id ?= @request.auth.id &&
    @collection.users:isBannedCheck.isBanned ?= false
  )
)
```

#### message集合 创建规则
```c
// 访问主体的前置条件，需登录
@request.auth.id != '' &&
// 访问主体的权限条件，非isBanned 且 判断canSendMessage
(
  // 非isBanned，且
  (
    @collection.users:isBannedCheck.id ?= @request.auth.id &&
    @collection.users:isBannedCheck.isBanned ?= false
  ) &&
  // 判断canSendMessage，为YES，或，为空且默认允许
  (
    // canSendMessage为YES，或
    (
      @collection.users:canSendMessageCheckYES.id ?= @request.auth.id &&
      @collection.users:canSendMessageCheckYES.canSendMessage ?= 'YES'
    ) ||
    // canSendMessage为空 且 默认允许
    (
      // canSendMessage为空，且
      (
        @collection.users:canSendMessageCheckEmpty.id ?= @request.auth.id &&
        @collection.users:canSendMessageCheckEmpty.canSendMessage ?= ''
      ) &&
      // 配置中默认允许
      (
        @collection.config:UCSMD.key ?= 'user-can-send-message-default' &&
        @collection.config:UCSMD.value ?= true
      )
    )
  )
) &&
// 资源本身的可访问性条件，创建时需为创建者（传入的author需为当前用户）
@request.body.author = @request.auth.id
```

#### message集合 更新规则
```c
// 访问主体的前置条件，需登录
@request.auth.id != '' &&
// 访问主体的权限条件，非isBanned 且 判断canSendMessage
(
  // 非isBanned，且
  (
    @collection.users:isBannedCheck.id ?= @request.auth.id &&
    @collection.users:isBannedCheck.isBanned ?= false
  ) &&
  // 判断canSendMessage，为YES，或，为空且默认允许
  (
    // canSendMessage为YES，或
    (
      @collection.users:canSendMessageCheckYES.id ?= @request.auth.id &&
      @collection.users:canSendMessageCheckYES.canSendMessage ?= 'YES'
    ) ||
    // canSendMessage为空 且 默认允许
    (
      // canSendMessage为空，且
      (
        @collection.users:canSendMessageCheckEmpty.id ?= @request.auth.id &&
        @collection.users:canSendMessageCheckEmpty.canSendMessage ?= ''
      ) &&
      // 配置中默认允许
      (
        @collection.config:UCSMD.key ?= 'user-can-send-message-default' &&
        @collection.config:UCSMD.value ?= true
      )
    )
  )
) &&
// 资源本身的可访问性条件
(
  // 修改消息需为创建者
  author.id = @request.auth.id &&
  // 禁止修改author
  @request.body.author:isset = false
)
```


### image集合 api规则
创建规则、修改规则 类似message集合

#### image集合 查看规则
```c
// 访问主体的前置条件 ，根据配置值判断未登录用户是否可以查看
(
  // 用户已登录，可以查看消息
  @request.auth.id != '' ||
  // 根据config，判断是否允许未登录用户查看消息
  (
    @collection.config:allowAnonymousView.key ?= 'allow-anonymous-view' &&
    @collection.config:allowAnonymousView.value ?= true
  )
) &&
// 访问主体的权限条件，isBanned需为false
(
  // 用户未登录时可通过，因为匿名访问已在前置条件控制
  @request.auth.id = '' ||
  // 用户已登录，检查其isBanned 为 false 才能通过
  (
    @collection.users:isBannedCheck.id ?= @request.auth.id &&
    @collection.users:isBannedCheck.isBanned ?= false
  )
)
```

#### image集合 创建规则
```c
// 访问主体的前置条件，需登录
@request.auth.id != '' &&
// 访问主体的权限条件，非isBanned 且 判断canUploadImage
(
  // 非isBanned，且
  (
    @collection.users:isBannedCheck.id ?= @request.auth.id &&
    @collection.users:isBannedCheck.isBanned ?= false
  ) &&
  // 判断canUploadImage，为YES，或，为空且默认允许
  (
    // canUploadImage为YES，或
    (
      @collection.users:canUploadImageCheckYES.id ?= @request.auth.id &&
      @collection.users:canUploadImageCheckYES.canUploadImage ?= 'YES'
    ) ||
    // canUploadImage为空 且 默认允许
    (
      // canUploadImage为空，且
      (
        @collection.users:canUploadImageCheckEmpty.id ?= @request.auth.id &&
        @collection.users:canUploadImageCheckEmpty.canUploadImage ?= ''
      ) &&
      // 配置中默认允许
      (
        @collection.config:UCUID.key ?= 'user-can-upload-image-default' &&
        @collection.config:UCUID.value ?= true
      )
    )
  )
) &&
// 资源本身的可访问性条件，创建时需为创建者（传入的author需为当前用户）
@request.body.author = @request.auth.id
```

#### image集合 更新规则
```c
// 访问主体的前置条件，需登录
@request.auth.id != '' &&
// 访问主体的权限条件，非isBanned 且 判断canUploadImage
(
  // 非isBanned，且
  (
    @collection.users:isBannedCheck.id ?= @request.auth.id &&
    @collection.users:isBannedCheck.isBanned ?= false
  ) &&
  // 判断canUploadImage，为YES，或，为空且默认允许
  (
    // canUploadImage为YES，或
    (
      @collection.users:canUploadImageCheckYES.id ?= @request.auth.id &&
      @collection.users:canUploadImageCheckYES.canUploadImage ?= 'YES'
    ) ||
    // canUploadImage为空 且 默认允许
    (
      // canUploadImage为空，且
      (
        @collection.users:canUploadImageCheckEmpty.id ?= @request.auth.id &&
        @collection.users:canUploadImageCheckEmpty.canUploadImage ?= ''
      ) &&
      // 配置中默认允许
      (
        @collection.config:UCUID.key ?= 'user-can-upload-image-default' &&
        @collection.config:UCUID.value ?= true
      )
    )
  )
) &&
// 资源本身的可访问性条件
(
  // 修改需为创建者
  author.id = @request.auth.id &&
  // 禁止修改author
  @request.body.author:isset = false
)
```

### config集合 api规则
任何人只允许查看，只允许超级用户操作

注意处理isBanned

