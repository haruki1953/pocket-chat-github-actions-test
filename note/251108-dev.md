## 后端pocketbase初始化，架构整理
```
调整数据库，只保留 users、config、messages
重新导出 pb_schema.json
重新生成迁移文件 pocketbase.exe migrate collections
pocketbase/start 脚本改为LF换行
将pocketbase\start.bat改回CRLF
```

## 前端修改
```
登录页 聊天页 设置页

修正滚动条样式
完成消息对话框阴影
完善消息用户名与时间的不可选择
完善通知提示框圆角
封装图标组
优化当前用户消息的用户信息，使修改自己的头像、名称等信息后，返回聊天页时不必再刷新就是已修改的
路由守卫中使用 usePbCollectionConfigQuery（useQuery）是不应该的，退而求其次使用 usePlaceholderDataPbCollectionConfigStore
消息加载中时跳转至设置页再返回时可能导致问题，十分严重，会导致页面卡死。可能是因为组件卸载后导致加载更多请求逻辑无限循环导致的
消息编辑请求时应禁用取消按钮
消息加载按钮加载中遮罩层级修复
回车发送消息
阻止发送纯空格换行内容
消息内容文字链接处理
头像修改卡片，头像加载中显示优化
首屏加载也等待消息与个人信息
实验移动端是否会触发@keydown.enter，会
实现手机软件盘回车不触发发送，改为 @keydown.shift.enter 即可
取消消息长按
解决聊天刷新后如果网络三次错误后，无法再次刷新的问题
消息发送，实时消息等待增加超时逻辑，超时后输入栏显示强制刷新，应对恶劣网络环境
console.log 清理
退出登录后应跳转至登录页
修改后端端口为18090
pb修改默认图标组
国际化添加更多语言，日语、韩语、俄语
解决加载图标抖动的问题
首屏遮罩增加额外300ms等待时间，以等待聊天页的加载图标过渡结束
输入栏 增加Shift + Enter提示 （不太好看，之后又取消了）

TODO

以后再进行
env控制 开发环境 与 生产环境 时的api地址等
超时时间可通过pb后端配置
当前配置的fetch超时，好像只会对未响应的请求生效，在开发者工具发现已响应但处理中的请求没有被超时控制
输入栏字数限制
```

## 测试部署
```
cat <<EOF > /etc/systemd/system/pocketchat-251109.service
[Unit]
Description=PocketChat Service
After=network.target

[Service]
Type=simple
WorkingDirectory=/root/pocketchat-251109
ExecStart=/bin/sh /root/pocketchat-251109/start.sh
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF

# 重新加载 systemd 配置
systemctl daemon-reload

# 启动服务
systemctl start pocketchat-251109
systemctl restart pocketchat-251109
systemctl stop pocketchat-251109

# 设置开机自启
systemctl enable pocketchat-251109

# 查看状态
systemctl status pocketchat-251109

# 查看全部日志
journalctl -u pocketchat-251109

# 实时跟踪日志
journalctl -u pocketchat-251109 -f

# 清除全部日志，需重启
journalctl --vacuum-time=1s
```

nginx 反向代理中配置浏览器缓存
```
为反向代理的内容配置一下浏览器缓存更好
不使用1panel的反向代理，自己用nginx配置设置
```
```nginx
    # 静态资源缓存
    location ~* \.(gif|png|jpg|jpeg|svg|webp|ico|css|js|woff|woff2|ttf|eot|otf|mp4|webm|ogg|mp3|wav|flac|m4a)$ {
        # 依然通过反向代理获取资源
        proxy_pass http://127.0.0.1:58090;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $http_connection;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;

        add_header X-Cache $upstream_cache_status;

        # 浏览器缓存策略：30天
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";

        proxy_ssl_server_name off;
        proxy_ssl_name $proxy_host;
    }

    # 动态内容（HTML、API 等）
    location / {
        proxy_pass http://127.0.0.1:58090;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $http_connection;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;

        add_header X-Cache $upstream_cache_status;

        # 不缓存动态内容
        add_header Cache-Control "no-cache";

        proxy_ssl_server_name off;
        proxy_ssl_name $proxy_host;
    }

```

## 打包脚本设计
```
pocket-chat 项目目录结构
- project-tools-node/
- vue3/
  - src/
  - dist/
  - package.json
- pocketbase/
  - pb_hooks/
  - pb_migrations/
  - pocketbase.exe
  - start.bat
  - start.sh
  - start_mac.sh
- pocketbase-release-file/
  - pocketbase_0.33.0_windows_amd64/
    - pocketbase.exe
  - pocketbase_0.33.0_linux_amd64/
    - pocketbase
  - pocketbase_0.33.0_linux_arm64/
    ……
  ……
- out/
  - 0.0.1/
    - dist/
      - pocket_chat_0.0.1_windows_amd64/
        - pb_hooks/
        - pb_migrations/
        - pb_public/
        - pocketbase.exe
        - start.bat
        - start.sh
        - start_mac.sh
        - CHANGELOG.md
        - LICENSE.md
      - pocket_chat_0.0.1_linux_amd64/
        - pb_hooks/
        - pb_migrations/
        - pb_public/
        - pocketbase.exe
        ……
      ……
    - release/
      - pocket_chat_0.0.1_windows_amd64.zip
      - pocket_chat_0.0.1_linux_amd64.zip
      ……
- CHANGELOG.md
- LICENSE.md
- README.md

project-tools-node/ 中会写一些js脚本 用于项目 打包 之类的操作
vue3/ 是前端项目目录
vue3/dist/ 是前端打包后的内容
pocketbase/ 是后端pocketbase的目录
pocketbase/pocketbase.exe 是pocketbase程序主体，在windows上是pocketbase.exe，在linux等其他平台上是pocketbase
pocketbase/start.bat、start.sh、start_mac.sh 是pocket-chat项目启动脚本
pocketbase-release-file/ 为存放不同平台的pocketbase可执行文件，打包时会从这里复制
out/ 打包时输出内容的文件夹

帮我在 project-tools-node/ 中写一个项目打包脚本 project-package.js
- 可以通过参数设置本项目版本号，如0.0.1 ，打包时根据版本号在out/里创建文件夹（如果已有则提示并退出）
- 脚本中有变量，可以配置项目名 如pocket_chat，用于和项目版本号、平台字符串拼接出输出dist目录或zip名 如pocket_chat_0.0.1_windows_amd64
- 脚本中有数组变量，可以配置打包哪些平台，如['windows_amd64', 'linux_amd64', 'linux_arm64']
- 脚本中有变量，可以配置pocketbase版本，和上述平台字符串就能拼接出pocketbase-release-file中的文件路径
- 创建文件夹或复制文件时，要能支持跨级创建，避免中间文件夹不存在导致的错误
- 打包时，在对应版本号如0.0.1/目录中，的dist/目录中，创建对应平台字符串的目录如 pocket_chat_0.0.1_windows_amd64/
- 如 pocket_chat_0.0.1_windows_amd64/ 目录中的内容，是从 pocketbase/ 中复制的
- 其中 pb_public/ 是新创建的文件夹，其中的内容是从 vue3/dist/ 中复制的
- 其中 CHANGELOG.md LICENSE.md 是从项目根目录复制的
- 得到有完整内容的如 dist/pocket_chat_0.0.1_windows_amd64/ 这样的文件夹后，就zip为如 release/pocket_chat_0.0.1_windows_amd64.zip 这样的

- 在开始操作之前，进行一些检查，判断打包过程中所需的文件是否存在，如：
  - 判断 vue3/dist/ 是否存在
  - 判断 pocketbase-release-file/ 中的内容是否全（根据脚本中有数组变量配置打包哪些平台）
  - 判断 CHANGELOG.md 中是否包含当前版本如 0.0.1 ，防止忘记更新
```

## 发布规程设计
```
更新/检查 README.md 

更新 CHANGELOG.md

前端打包

运行项目打包脚本
node project-package.js VERSION
node project-tools-node/project-package.js VERSION

上述运行无误，git提交，确认在主分支，打标签，或在release时创建标签
```

版本号
```
标签和release时的标题应该带v，如 v0.0.1
CHANGELOG.md 中不要带v，如 0.0.1
```


## 文档编写
```
为了编写文档，停止测试部署的项目，主要是要别让 pocketchat.service 占用

部署演示：

cloudflare添加uika.top

DNS -> 设置
启用 DNSSEC ，根据其弹出的说明，需要在prokbun也进行配置（配置dsData即可）

SSL/TLS -> 概述 -> SSL/TLS 加密 ，配置为“完全”比较好

SSL/TLS -> 边缘证书
是否始终使用 HTTPS，按需选择
是否自动 HTTPS 重写，按需选择

缓存 -> 配置
浏览器缓存 TTL 遵循现有标头（需自己配置缓存），或者设置为几个月（自己不控制缓存）


```


## 消息通知
```
有新消息时网站图标与标题改变
```

## github-actions发布
```
参考
https://github.com/maginawin/ha-dali-center/blob/main/CLAUDE.md#release-process
https://github.com/maginawin/ha-dali-center/blob/main/.github/workflows/release.yml
```

